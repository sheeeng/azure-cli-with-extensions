name: Run Pre-Commit via Determinate

permissions:
  actions: write
  contents: read

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref || github.sha }}"
  cancel-in-progress: true

jobs:
  run-pre-commit:
    name: Run Pre-Commit
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - uses: determinatesystems/nix-installer-action@45a18a69953f27af3c2bfad0a5e01c38ef2da462 # v20
      - uses: determinatesystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13
      - uses: determinatesystems/flake-checker-action@3164002371bc90729c68af0e24d5aacf20d7c9f6 # v12

      - name: Reuse Cache or Rebuild
        timeout-minutes: 15 # Allow sufficient buffer time for Nix to rebuild Nix store.
        run: |
          echo "=== Building with Using Shell ==="
          # Build the development shell without entering it.
          nix build .#devShells.x86_64-linux.default --no-link || {
            echo "Failed to build development shell, trying alternative approach..."
            # Try flake check to validate the flake.
            nix flake check --no-eval-cache || echo "Flake check failed."
          }

          echo "=== Use Shell ==="
          nix develop --command bash -c "
            echo 'Successfully entered nix develop environment.'
            echo \"\${PATH}: \${PATH}\"
            echo 'Checking for pre-commit...'
            if ! command -v pre-commit &> /dev/null; then
              echo '❌ Missing pre-commit tool.'
              echo 'Available commands in environment:'
              compgen -c | grep -E '^(pre-commit|terraform|keep-sorted|az)' | head -10
              exit 1
            fi
            echo '✅ Found pre-commit \$(pre-commit --version | cut --delimiter=\" \" --fields=2) in Nix environment.'
          "

      - name: Install Pre-Commit
        timeout-minutes: 5 # Nix store should already be built and cached. But, install hooks from external sources may take time.
        run: |
          nix develop --command bash -c '
            echo "Installing pre-commit hooks..."
            pre-commit install-hooks
          '
      - name: Run Pre-Commit
        timeout-minutes: 5 # Nix store should already be built and cached. But, running hooks on all files may take time.
        run: |
          nix develop --command bash -c "
            echo 'Pre-Commit Version: \$(pre-commit --version)'
            echo 'Installing pre-commit hooks...'
            pre-commit install-hooks
            # Run pre-commit on all files for push to main branch, otherwise only on changed files.
            if [[ \"\${{ github.event_name }}\" == \"push\" && \"\${{ github.ref }}\" == \"refs/heads/main\" ]]; then
              echo 'Running pre-commit on all files (push to main branch)'
              pre-commit run --all-files
            else
              echo 'Running pre-commit on changed files only'
              # For pull requests, run on files changed compared to the target branch.
              if [[ \"\${{ github.event_name }}\" == \"pull_request\" ]]; then
                pre-commit run --from-ref=origin/\${{ github.base_ref }} --to-ref=HEAD
              else
                # For other events, run on all files as fallback.
                pre-commit run --all-files
              fi
            fi
          "
